<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>UDiskBackup</title>
  <link rel="stylesheet" href="/app.css"/>
</head>
<body>
  <h1>UDiskBackup</h1>

  <!-- BANER ŹRÓDŁA -->
  <div id="src-banner" class="banner bad" style="display:none">
    <strong>Źródło niedostępne.</strong>
    <span class="muted">Sprawdź, czy katalog /mnt/shared jest zamontowany i czytelny.</span>
  </div>
  <div id="src-banner-ok" class="banner ok" style="display:none">
    <strong>Źródło dostępne:</strong>
    <span id="src-banner-path" class="muted"></span>
    <span id="src-banner-size" class="muted" style="margin-left:.5rem"></span>
  </div>

  <!-- BANER USB -->
  <div id="usb-banner" class="banner bad" style="display:none">
    <strong>Brak kwalifikującego się dysku USB.</strong>
    <span class="muted">Wymagany label <code>USB_BACKUP</code> i rozmiar &gt; 0 B. Podłącz dysk i kliknij „Odśwież”.</span>
  </div>
  <div id="usb-banner-ok" class="banner ok" style="display:none">
    <strong>Wykryto dysk(i) USB (USB_BACKUP):</strong>
    <span id="usb-banner-count" class="muted"></span>
  </div>

  <!-- PANEL BACKUPU -->
  <div class="panel" style="margin-bottom:1rem">
    <div class="actions">
      <strong>Backup do USB</strong>
      <select id="usb-target" class="btn" style="min-width:280px"></select>
      <button class="btn" id="plan">Sprawdź miejsce</button>
      <button class="btn" id="start">Start backup</button>
      <span class="muted" id="plan-info"></span>
    </div>

    <!-- Live podgląd -->
    <div class="log-toolbar">
      <strong>Live podgląd:</strong>
      <label><input type="checkbox" id="flt-info" checked> INFO</label>
      <label><input type="checkbox" id="flt-progress" checked> PROGRESS</label>
      <label><input type="checkbox" id="flt-error" checked> ERROR</label>
      <label><input type="checkbox" id="autoscroll" checked> Autoscroll</label>
      <button class="btn" id="clear-log">Wyczyść</button>
      <a class="btn" id="download-current" href="/api/backup/current-log?download=1">Pobierz bieżący log</a>
    </div>
    <div id="backup-log" class="logview"></div>
  </div>

  <div class="row">
    <!-- Lewa kolumna: status USB -->
    <div class="panel">
      <div class="actions">
        <button class="btn" id="refresh">Odśwież</button>
        <span class="muted">Skanowanie ręczne: kliknij, aby wykryć aktualne dyski.</span>
      </div>
      <hr style="border:none;border-top:1px solid var(--bd);margin:.8rem 0">
      <div class="status">
        <div id="usb-dot" class="dot bad"></div>
        <div>
          <div id="usb-title"><strong>Brak podłączonego dysku USB</strong></div>
          <div class="muted" id="usb-sub">Wymagany label <code>USB_BACKUP</code> na partycji i rozmiar &gt; 0 B.</div>
        </div>
      </div>
      <div id="usb-cards" class="usb-cards" style="display:none"></div>
    </div>

    <!-- Prawa kolumna: pełna tabela dysków -->
    <div class="panel">
      <div class="actions" style="justify-content:space-between">
        <div><strong>Wszystkie dyski</strong></div>
      </div>
      <table id="grid">
        <thead>
          <tr>
            <th>Urządzenie</th>
            <th>Rodzaj</th>
            <th>Transport</th>
            <th>Vendor / Model</th>
            <th>Serial</th>
            <th>Rozmiar</th>
            <th>Rotational</th>
            <th>Etykieta</th>
            <th>Partycje</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- HISTORIA BACKUPÓW -->
  <div class="panel" style="margin-top:1rem">
    <div class="actions" style="justify-content:space-between">
      <div><strong>Historia backupów</strong></div>
      <div class="actions">
        <label class="muted">Filtr (mount):</label>
        <select id="hist-filter" class="btn" style="min-width:220px"></select>
        <button class="btn" id="hist-refresh">Odśwież</button>
      </div>
    </div>
    <table id="hist">
      <thead>
        <tr>
          <th>Start (lokalnie)</th>
          <th>Wynik</th>
          <th>Przesłane</th>
          <th>Plików</th>
          <th>Czas</th>
          <th>Cel (mount)</th>
          <th>Podsumowanie</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://unpkg.com/@microsoft/signalr@8.0.5/dist/browser/signalr.min.js"></script>
  <script>
    // ---- Helpers ----
    async function fetchJson(url){ const r=await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    function human(b){ if(b==null) return '-'; const u=['B','KB','MB','GB','TB','PB']; let i=0,n=Number(b); while(n>=1024&&i<u.length-1){n/=1024;i++;} return n.toFixed(n<10?2:n<100?1:0)+' '+u[i]; }
    function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',5000); }
    function dtLocal(iso){ try{ return new Date(iso).toLocaleString(); }catch{ return iso; } }

    // ---- Global ----
    let sourceAvailable = false;
    let lastPlan = null;

    // ---- Source status ----
    async function loadSource(){
      try{
        const s = await fetchJson('/api/source/status');
        sourceAvailable = !!(s.exists && s.readable);
        showSourceBanner(s);
      }catch(e){
        console.error(e); sourceAvailable = false;
        showSourceBanner({path:'/mnt/shared', exists:false, readable:false, usedBytes:null});
      }
      enforceButtons();
    }
    function showSourceBanner(s){
      const bad = document.getElementById('src-banner');
      const ok  = document.getElementById('src-banner-ok');
      const p   = document.getElementById('src-banner-path');
      const sz  = document.getElementById('src-banner-size');
      if (s.exists && s.readable){
        bad.style.display='none'; ok.style.display='flex';
        p.textContent = s.path || '/mnt/shared';
        sz.textContent = s.usedBytes!=null ? `— zajętość ~ ${human(s.usedBytes)}` : '';
      } else { ok.style.display='none'; bad.style.display='flex'; }
    }

    // ---- USB targets (backup) ----
    async function loadTargets(){
      const sel = document.getElementById('usb-target');
      const filter = document.getElementById('hist-filter');
      sel.innerHTML = '';
      try{
        const t = await fetchJson('/api/backup/targets');
        if (t.length === 0){
          sel.disabled = true;
          const opt = document.createElement('option'); opt.value=''; opt.textContent='Brak kwalifikujących się dysków USB';
          sel.appendChild(opt);
          showUsbBanner(false, 0);
        } else {
          sel.disabled = false;
          for (const x of t){
            const opt = document.createElement('option');
            opt.value = x.mountPoint;
            opt.textContent = `${x.mountPoint} (${x.fsType}) — wolne ${human(x.freeBytes)} z ${human(x.totalBytes)}`;
            sel.appendChild(opt);
          }
          showUsbBanner(true, t.length);
        }

        // filtr historii
        filter.innerHTML = '';
        const all = document.createElement('option'); all.value = ''; all.textContent = 'Wszystkie podłączone';
        filter.appendChild(all);
        for (const x of t){
          const opt = document.createElement('option');
          opt.value = x.mountPoint;
          opt.textContent = x.mountPoint;
          filter.appendChild(opt);
        }
      }catch(e){
        console.error(e);
        sel.disabled = true;
        const opt = document.createElement('option'); opt.value=''; opt.textContent='Błąd ładowania celów USB';
        sel.appendChild(opt);
        showUsbBanner(false, 0);
      }
      enforceButtons();
    }

    // ---- Backup actions ----
    async function planBackup(){
      const sel = document.getElementById('usb-target');
      const mp = sel.value;
      if (!mp){ setPlan('Wybierz cel USB'); return; }
      if (!sourceAvailable){ setPlan('Źródło /mnt/shared niedostępne'); return; }
      try{
        const p = await fetchJson('/api/backup/plan?targetMount=' + encodeURIComponent(mp));
        lastPlan = p;
        const need = human(p.estimatedBytes), free = human(p.freeBytes);
        setPlan(`${p.enoughSpace ? 'OK' : 'ZA MAŁO MIEJSCA'} — potrzeba ${need}, wolne ${free}. Katalog docelowy: ${p.targetBackupDir}`);
        if (!p.enoughSpace){ showToast(`Za mało miejsca: potrzeba ${need}, wolne ${free}.`); }
      }catch(e){ setPlan('Błąd planowania: ' + e.message); lastPlan = null; }
      enforceButtons();
    }

    async function startBackup(){
      clearLog();
      const sel = document.getElementById('usb-target');
      const mp = sel.value;
      if (!mp){ setPlan('Wybierz cel USB'); return; }
      if (!sourceAvailable){ setPlan('Źródło /mnt/shared niedostępne'); return; }

      // ZAWSZE sprawdź plan tuż przed startem
      try{
        const p = await fetchJson('/api/backup/plan?targetMount=' + encodeURIComponent(mp));
        lastPlan = p;
        if (!p.enoughSpace){
          const need = human(p.estimatedBytes), free = human(p.freeBytes);
          setPlan(`ZA MAŁO MIEJSCA — potrzeba ${need}, wolne ${free}.`);
          showToast(`Nie mogę wystartować: za mało miejsca (potrzeba ${need}, wolne ${free}).`);
          enforceButtons(); return;
        }
      }catch(e){ appendLog('error','Błąd planowania: ' + e.message); return; }

      try{
        const resp = await fetch('/api/backup/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({targetMount: mp})});
        if(!resp.ok){ const t = await resp.text(); appendLog('error', t); showToast(t); return; }
        const { operationId } = await resp.json();
        appendLog('info', `[${new Date().toLocaleTimeString()}] Start backup (opId ${operationId})`);
        // po starcie dociągnij ogon bieżącego logu (gdyby stracone wydarzenia)
        fetchCurrentLog();
      }catch(e){ appendLog('error','Błąd uruchamiania: ' + e.message); }
    }

    function setPlan(msg){ document.getElementById('plan-info').textContent = msg; }

    // ---- Live log UI ----
    function lineVisible(level){
      if(level==='error') return document.getElementById('flt-error').checked;
      if(level==='progress') return document.getElementById('flt-progress').checked;
      return document.getElementById('flt-info').checked;
    }
    function appendLog(level, text, ts){
      const wrap = document.getElementById('backup-log');
      const div = document.createElement('div');
      div.className = `logline ${level}`;
      const time = ts ? new Date(ts).toLocaleTimeString() : new Date().toLocaleTimeString();
      div.innerHTML = `<span class="ts">${time}</span><span class="msg"></span>`;
      div.querySelector('.msg').textContent = text;
      div.style.display = lineVisible(level) ? '' : 'none';
      wrap.appendChild(div);
      if (document.getElementById('autoscroll').checked){ wrap.scrollTop = wrap.scrollHeight; }
    }
    function clearLog(){ document.getElementById('backup-log').innerHTML=''; }
    function applyFilters(){
      const wrap = document.getElementById('backup-log');
      for (const el of wrap.querySelectorAll('.logline')){
        const classes = el.className.split(/\s+/);
        const level = classes.find(c => ['info','progress','error','warn'].includes(c)) || 'info';
        el.style.display = lineVisible(level) ? '' : 'none';
      }
    }
    async function fetchCurrentLog(){
      try{
        const r = await fetch('/api/backup/current-log');
        if(!r.ok) return;
        const text = await r.text();
        for (const ln of text.split('\n')){
          if(!ln.trim()) continue;
          // heurystyka poziomu
          let lvl = 'info';
          if (/ERROR|rsync error|failed/i.test(ln)) lvl='error';
          else if (/%\s+/.test(ln) || /to-check=\d+\/\d+/.test(ln)) lvl='progress';
          appendLog(lvl, ln);
        }
      }catch{}
    }

    document.getElementById('clear-log').onclick = clearLog;
    document.getElementById('flt-info').onchange = applyFilters;
    document.getElementById('flt-progress').onchange = applyFilters;
    document.getElementById('flt-error').onchange = applyFilters;

    // ---- Disks view ----
    async function loadAll(){
      try{
        const data = await fetchJson('/api/disks');
        renderTable(data);
        const usb = await fetchJson('/api/disks/usb');
        renderUsbPanel(usb);
        showUsbBanner(usb.length>0, usb.length);
      }catch(e){ console.error(e); }
    }
    function renderTable(data){
      const tb = document.querySelector('#grid tbody'); tb.innerHTML='';
      for (const d of data){
        const tr = document.createElement('tr');
        const diskLabel = (d.partitions||[]).map(p => p.label).find(x => !!x) || '';
        const parts = (d.partitions||[]).map(p => {
          const f = p.fstype ?? '-';
          const m = p.mountPoint ?? '-';
          const lab = p.label ? `, label: ${p.label}` : '';
          return `${p.path} (${f}, ${p.size}, ${m}${lab})`;
        }).join('<br/>');
        tr.innerHTML = `
          <td>${d.path}</td>
          <td><span class="label">${d.type}</span></td>
          <td><span class="label">${d.transport ?? '-'}</span></td>
          <td>${(d.vendor||'') + ' ' + (d.model||'')}</td>
          <td>${d.serial||''}</td>
          <td>${d.size||''}</td>
          <td>${d.rotational}</td>
          <td>${diskLabel || '-'}</td>
          <td>${parts||''}</td>`;
        tb.appendChild(tr);
      }
    }
    function renderUsbPanel(usbDisks){
      const dot  = document.getElementById('usb-dot');
      const title= document.getElementById('usb-title');
      const sub  = document.getElementById('usb-sub');
      const wrap = document.getElementById('usb-cards');

      if (usbDisks.length === 0){
        dot.classList.remove('ok'); dot.classList.add('bad');
        title.innerHTML = '<strong>Brak podłączonego dysku USB</strong>';
        sub.textContent = 'Wymagany label USB_BACKUP i rozmiar > 0 B. Podłącz dysk, a potem kliknij „Odśwież”.';
        wrap.style.display = 'none'; wrap.innerHTML = ''; return;
      }
      dot.classList.remove('bad'); dot.classList.add('ok');
      title.innerHTML = `<strong>Wykryto dysk${usbDisks.length>1?'i':''} USB: ${usbDisks.length}</strong>`;
      sub.textContent = 'Parametry podłączonych urządzeń:';
      wrap.style.display = 'grid'; wrap.innerHTML = '';
      for (const d of usbDisks){
        const firstLabel = (d.partitions||[]).map(p => p.label).find(x => !!x) || '-';
        const parts = (d.partitions||[]).map(p => {
          const lab = p.label ? `, label: ${p.label}` : '';
          return `${p.path} (${p.fstype ?? '-'}, ${p.size}, ${p.mountPoint ?? '-'}${lab})`;
        }).join('<br/>') || '<span class="muted">brak partycji</span>';
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.35rem">
            <div><strong>${(d.vendor||'') + ' ' + (d.model||'')}</strong></div>
            <div><span class="label">USB</span><span class="label">${(d.type||'').toUpperCase()}</span></div>
          </div>
          <div class="muted" style="margin-bottom:.35rem">${d.path}</div>
          <div><strong>Etykieta:</strong> ${firstLabel} &nbsp;&nbsp; <strong>Serial:</strong> ${d.serial || '-'}</div>
          <div><strong>Rozmiar:</strong> ${d.size || '-'}</div>
          <div style="margin-top:.5rem"><strong>Partycje:</strong><br/>${parts}</div>`;
        wrap.appendChild(card);
      }
    }
    function showUsbBanner(present, count){
      const bad = document.getElementById('usb-banner');
      const ok  = document.getElementById('usb-banner-ok');
      const cnt = document.getElementById('usb-banner-count');
      if (present){ bad.style.display='none'; ok.style.display='flex'; cnt.textContent = `wykryto ${count}`; }
      else { ok.style.display='none'; bad.style.display='flex'; }
    }

    function enforceButtons(){
      const sel = document.getElementById('usb-target');
      const btnPlan = document.getElementById('plan');
      const btnStart = document.getElementById('start');
      const hasUsb = sel && !sel.disabled && !!sel.value;
      btnPlan.disabled = !(sourceAvailable && hasUsb);
      const planOk = (lastPlan == null) ? true : !!lastPlan.enoughSpace;
      btnStart.disabled = !(sourceAvailable && hasUsb && planOk);
    }

    // ---- Historia ----
    async function loadHistory(){
      const filter = document.getElementById('hist-filter');
      const q = filter.value ? ('?targetMount=' + encodeURIComponent(filter.value)) : '';
      const items = await fetchJson('/api/backup/history' + q);
      renderHistory(items);
    }
    function renderHistory(items){
      const tb = document.querySelector('#hist tbody'); tb.innerHTML='';
      for (const it of items){
        const tr = document.createElement('tr');
        const pill = `<span class="pill ${it.success?'ok':'bad'}">${it.success?'OK':'Błąd'}</span>`;
        const size = it.totalTransferredFileSize!=null ? human(it.totalTransferredFileSize) : '-';
        const cnt  = it.numberOfTransferredFiles?.toString() ?? '-';
        const sum  = it.summaryTxtPath || it.summaryJsonPath;
        tr.innerHTML = `
          <td>${dtLocal(it.startedAtUtc)}</td>
          <td>${pill}</td>
          <td>${size}</td>
          <td>${cnt}</td>
          <td>${fmtDuration(it.duration)}</td>
          <td><code>${it.targetMount}</code></td>
          <td style="max-width:420px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"><code title="${sum}">${sum}</code></td>
        `;
        tb.appendChild(tr);
      }
      if (items.length === 0){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="7" class="muted">Brak podsumowań na podłączonych dyskach.</td>`;
        tb.appendChild(tr);
      }
    }
    function fmtDuration(span){
      if (typeof span === 'string'){
        const parts = span.split(':'); if (parts.length>=2) return `${parts[0]}h ${parts[1]}m ${parts[2]?.split('.')[0]||'0'}s`;
        return span;
      }
      return '-';
    }

    // ---- Events / init ----
    document.getElementById('plan').onclick = planBackup;
    document.getElementById('start').onclick = startBackup;
    document.getElementById('refresh').onclick = ()=>{ lastPlan=null; setPlan(''); loadAll(); loadTargets(); loadSource(); loadHistory(); enforceButtons(); };
    document.getElementById('hist-refresh').onclick = ()=> loadHistory();
    document.getElementById('hist-filter').onchange = ()=> loadHistory();

    // Pierwsze załadowanie
    loadAll(); loadTargets(); loadSource(); loadHistory();

    // SignalR – dyski: tylko powiadomienia
    const conn = new signalR.HubConnectionBuilder().withUrl('/hubs/disks').withAutomaticReconnect().build();
    conn.on('deviceAdded',  evt => { showToast(`Wykryto nowe urządzenie (USB?): ${evt.name}. Kliknij „Odśwież”.`); });
    conn.on('deviceRemoved',evt => { showToast(`Odłączono urządzenie: ${evt.path}. Kliknij „Odśwież”.`); });
    conn.start().catch(err => console.error('SignalR error:', err));

    // SignalR – live log z backupu (obsługa starego i nowego formatu)
    const bconn = new signalR.HubConnectionBuilder().withUrl('/hubs/backup').withAutomaticReconnect().build();
    bconn.on('backupLog', payload => {
      if (typeof payload === 'string'){ appendLog('info', payload); return; }
      const lvl = payload.level || 'info';
      appendLog(lvl, payload.line || payload.message || '', payload.ts);
    });
    bconn.on('backupStatus', s => {
      appendLog('info', `[${s.state}] ${s.message}`);
      if (s.state === 'Completed' || s.state === 'Failed') { loadHistory(); }
    });
    bconn.start().then(fetchCurrentLog).catch(err => console.error('Backup hub error:', err));

    function setPlan(msg){ document.getElementById('plan-info').textContent = msg; }
  </script>
</body>
</html>
